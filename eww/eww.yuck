;; ** Status **

(defpoll wifi-img :interval "10s" "bash ~/.config/eww/scripts/wifi.sh | head -n1")
(defpoll wifi-name :interval "10s" "bash ~/.config/eww/scripts/wifi.sh | tail -n1")

(defpoll user-img :interval "10s" "bash ~/.config/eww/scripts/username.sh | head -n1")
(defpoll user-name :interval "10s" "bash ~/.config/eww/scripts/username.sh | tail -n1")

(defpoll volume-img :interval "0.5s" "bash ~/.config/eww/scripts/volume.sh | head -n1")
(defpoll volume :interval "0.5s" "bash ~/.config/eww/scripts/volume.sh | tail -n1")

(defpoll battery-img :interval "10s" "bash ~/.config/eww/scripts/battery.sh | sed -n '1p'")
(defpoll battery :interval "10s" "bash ~/.config/eww/scripts/battery.sh | sed -n '2p'")
(defpoll battery-status :interval "5s" "bash ~/.config/eww/scripts/battery.sh | sed -n '3p'")

(defwidget battery-box []
  (box :orientation "h"
       :valign "center"
       :spacing 8
       :halign "center"
       :space-evenly false
       :vexpand false
       :hexpand false
       :class "battery-box"
    (image :path battery-img
           :image-width 30
           :image-height 30
           :class {battery-status == "Charging" ? 'battery charging' : 'battery'}
           :preserve-aspect-ratio true)
    (label :text battery :halign "start" :class "text-box")
  )
)

(defwidget volume-box []
  (box :orientation "h"
       :valign "center"
       :spacing 8
       :halign "center"
       :space-evenly false
       :vexpand false
       :hexpand false
       :class "volume-box"
    (image :path volume-img
           :image-width 30
           :image-height 30
           :preserve-aspect-ratio true)
    (label :text volume :halign "start" :class "text-box")
  )
)

(defwidget wifi-box []
  (box :orientation "h"
       :valign "center"
       :spacing 8
       :halign "center"
       :space-evenly false
       :vexpand false
       :hexpand false
       :class "wifi-box"
    (image :path wifi-img
           :image-width 30
           :image-height 30
           :preserve-aspect-ratio true)
    (label :text wifi-name :halign "start" :class "text-box")
  )
)

(defwidget user-box []
  (box :orientation "h"
       :valign "center"
       :spacing 8
       :halign "center"
       :space-evenly false
       :vexpand false
       :hexpand false
       :class "user-box"
    (box :class "user-img-box"
         :style "background-image: url('${user-img}');")
    (label :text user-name :halign "start" :class "text-box")
  )
)

(defwidget status-bar []
  (box :orientation "h"
       :space-evenly false
       :halign "end"
       :valign "center"
       :spacing 15
       :class "box"
    (battery-box)
    (volume-box)
    (wifi-box)
    (user-box)
  )
)

;; ** Music **
(defpoll song :interval "1s" "bash ~/.config/eww/scripts/music_info.sh | cut -d'|' -f1")
(defpoll artist :interval "1s" "bash ~/.config/eww/scripts/music_info.sh | cut -d'|' -f2")
(defpoll poster :interval "1s" "bash ~/.config/eww/scripts/music_info.sh | cut -d'|' -f3")
(defpoll software :interval "1s" "bash ~/.config/eww/scripts/music_info.sh | cut -d'|' -f4")
(defpoll img :interval "1s" "bash ~/.config/eww/scripts/music_info.sh | cut -d'|' -f5")
(defpoll is_playing :interval "1s" "bash ~/.config/eww/scripts/music_control.sh status | tail -n1")


(defwidget music-bar []
  (box :class "box" :space-evenly false
    (box :orientation "h" :spacing 0 :valign "center" :halign "start" :space-evenly false :vexpand false :hexpand false
     (box :class "album" :valign "center" :halign "center" :vexpand false :hexpand false :style "background-image: url('${poster}');" :space-evenly: false)
     (box :class "musicbox" :orientation "v" :spacing 0 :valign "center" :halign "start" :space-evenly "false" :vexpand "false" :hexpand "false"
					(label :class "song" :halign "start" :wrap "false" :limit-width 20 :text song)
					(label :class "artist" :halign "start" :wrap "false" :limit-width 20 :text artist))
    )
    (box :class "music-buttons" :orientation "h" :spacing 5 :valign "center" :halign "end" :space-evenly false :vexpand false :hexpand false
      (button :style "background-image: url('/home/ru4f/.config/eww/icons/music/previous.png');" :class "trackbutton" :onclick "bash /home/ru4f/.config/eww/scripts/music_control.sh prev")
      (button :class "playbutton" 
              :onclick "bash /home/ru4f/.config/eww/scripts/music_control.sh play-pause" 
              :style { is_playing == "Playing"
                 ? "background-image: url('/home/ru4f/.config/eww/icons/music/pause-button.png');"
                 : "background-image: url('/home/ru4f/.config/eww/icons/music/play-button.png');" }
      )
      (button :style "background-image: url('/home/ru4f/.config/eww/icons/music/next.png');" :class "trackbutton" :onclick "bash /home/ru4f/.config/eww/scripts/music_control.sh next")
    )
  )
)

;; ** Weather & datetime **

(defpoll time :interval "5s" "bash ~/.config/eww/scripts/time.sh | head -n1")
(defpoll date :interval "10s" "bash ~/.config/eww/scripts/time.sh | tail -n1")
(defpoll celsius :interval "15s" "bash ~/.config/eww/scripts/weather.sh | cut -d'|' -f2")
(defpoll weather-img :interval "15s" "bash ~/.config/eww/scripts/weather.sh | cut -d'|' -f1")
(defpoll weather-title :interval "15s" "bash ~/.config/eww/scripts/weather.sh |cut -d'|' -f3")

(defwidget wd-bar []
 (box :class "box" :space-evenly false :spacing 30
  (box :orientation "v" :spacing 0 :valign "center" :halign "start" :vexpand false :hexpand false  
   (box :orientation "h" :space-evenly false :valign "center" :halign "start"
    (image :path "/home/ru4f/.config/eww/icons/date/clock.png"
           :image-width 20
           :image-height 20
           :preserve-aspect-ratio true)
    (label :text time  :wrap "false" :halign "start" :class "time")
   )
   (box :orientation "h" :space-evenly false :class "date-items" :valign "center" :halign "end"
    (image :path "/home/ru4f/.config/eww/icons/date/calendar.png"
           :image-width 20
           :image-height 20
           :preserve-aspect-ratio true)
    (label :text date :wrap "false" :halign "start" :class "date")
   )
  )
  (box :orientation "v" :spacing 0 :valign "center" :halign "end" :vexpand false :hexpand false
   (box :orientation "h" :space-evenly false :valign "center" :halign "start"
    (image :path weather-img
           :image-width 20
           :image-height 20
           :preserve-aspect-ratio true)
    (label :text celsius :wrap false :halign "start" :class "time")
   )
   (box :space-evenly false :class "date-items" :valign "center" :halign "end"
    (label :text weather-title :wrap false :halign "start" :class "date") 
   )
  ) 
 )
)

;; ** WINDOWS **

(defwindow bar
  :monitor 0
  :geometry (geometry :x "0px"
                      :y "0px"
                      :width "100%"
                      :height "50px"
                      :anchor "top center")
  :stacking "fg"
  :exclusive true
  :focusable false
  (box :orientation "h" :space-evenly false :halign "end" :valign "center" :spacing 15
   (wd-bar)
   (music-bar)
   (status-bar)
  )
)

